<!DOCTYPE html>
<html>
  
<head>
  <title>Gists</title>
  <script src="https://fb.me/react-15.1.0.js"></script>
  <script src="https://fb.me/react-dom-15.1.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
  <script src="https://npmcdn.com/react-router@2.4.0/umd/ReactRouter.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <link href="http://localhost:8080/Opinnaytetyo_spring/css/Gists.css" rel="stylesheet" type="text/css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js" type="text/javascript"></script>
  <!--  <script src="Application.js"></script>-->
 
</head>
  
<body>
  
  <div class="container">
  
  </div>
  
</body>
  
<script type="text/babel">
const destination = document.querySelector(".container");

var {Router,
		Route,
		IndexRoute,
		IndexLink,
		Link 
	} = ReactRouter;


var Gists = React.createClass({
	
	getInitialState: function() {
		return {
			gists: [],
			selectedGist: "",
			gist: null
	    };
	},

	
	getSingleGist: function(id) {
		this.getGist = $.ajax({
			headers: { 
	        	'Accept': 'application/json',
	       		'Content-Type': 'application/json' 
	   		},
			type: "GET",
			url: "http://localhost:8080/Opinnaytetyo_spring_react/singlegist?id=" + id,
			contentType: "application/json",
			dataType: 'json'
		})
		.success(function(result) {
	     	 this.setState({
				gist: result
			});		
  		}.bind(this));
	},


	/*Haetaan gistit jos komponentin mounttaus onnistui*/
	componentWillMount: function() {
		this.getGists = $.ajax({
			headers: { 
	        	'Accept': 'application/json',
	       		'Content-Type': 'application/json' 
	   		},
			type: "GET",
			url: "http://localhost:8080/Opinnaytetyo_spring_react/gists",
			contentType: "application/json",
			dataType: 'json'
		})
		.success(function(result) {
	      	this.setState({
				gists: result,
				selectedGist: result[0].id
			});	
			this.getSingleGist(result[0].id); 	
  		}.bind(this));	

	},

	/*Keskeytetään haku jos mounttaus epäonnistuu*/
	componentWillUnmount: function() {
		this.getGists.abort();
	},
	

	changeSelected: function(id) {	
		this.setState({selectedGist: id});
		this.getSingleGist(id);
	},
	

	


	render: function() {
		console.log("rerendering")
		console.log(this.state.gist)
		
		
		return (			
			<div>
				<LeftContent changeSelected={this.changeSelected} selectedGist={this.state.selectedGist} gists={this.state.gists} />	
				<RightContent gist={this.state.gist} />
			</div>
		)
	}

});


var LeftContent = React.createClass({
	
	render: function() {
		return (
			<div className="contentLeft">
				<GistList changeSelected={this.props.changeSelected} 
						selectedGist={this.props.selectedGist} gists={this.props.gists} />	
			</div>
		)
	}

});


var RightContent = React.createClass({
	
	render: function() {
		return (
			<div className="contentRight">
				<ShowSelectedGist gist={this.props.gist} />
			</div>
		)
	}

});





var GistList = React.createClass({
	
	handleClick: function(e) {
		var id = e.target.id;
		this.props.changeSelected(id);
	},	

	render: function() {
		console.log(this.props.selectedGist);
		var gists = this.props.gists.map(gist => 
			<SingleGist key={gist.id} id={gist.id} name={gist.files[0].filename} 
					url={gist.url} description={gist.description} ownerLogin={gist.owner.login} 
					selectedGist={this.props.selectedGist} handleClick={this.handleClick}/>
		);
			
	    return (
	    	<div className="listGists">
				{gists}
			</div>
	    )
	}

});


var SingleGist = React.createClass({
	
	render: function() {
		return (
			<div className={this.props.selectedGist === this.props.id ? "singleGist selected" : "singleGist"} 
					id={this.props.id} onClick={this.props.handleClick}>
				<div className="singleGistContainer">
					<p className="gistOwner">{this.props.ownerLogin} / <a href={this.props.url}>{this.props.name}</a></p>
					<p className="description">{this.props.description}</p>
				</div>
			</div>
		)
	}

});









var ShowSelectedGist = React.createClass({
	
	render: function() {
		if(this.props.gist === null) {	
			return <div className="loading"></div>;	
		}
		else {
			var files = this.props.gist.files.map(function(file, index) { 
				return <GistFile key={file.filename} filename={file.filename} content={file.content} editorId={"editor" + index} />
			});

			return (
				<div className="ShowActiveGist">
					<GistInfo name={this.props.gist.files[0].filename} description={this.props.gist.description} 
							viewUrl={this.props.gist.viewUrl} owner={this.props.gist.owner.login} avatarUrl={this.props.gist.avatarUrl} />
		
					<div className="gistFiles">
						{files}
					</div>
				</div>
	   	 	)
		}
	}

});




var GistInfo = React.createClass({
	
	render: function() {
		return (
			<div className="gistInfo">
				<img className="ownerAvatar" src={this.props.avatarUrl} />
				<a id="viewGist" href="{this.props.viewUrl}">{this.props.owner + " / "}{this.props.name}</a>
				{/*TODO: napit, kuvaus, yms.*/} 		
         	</div>
	    )
	}

});


var GistFile = React.createClass({

	componentDidMount: function() {
		createEditor(this.props.editorId, this.props.content);
	},

	render: function() {
		return (
			<div className="gistFile">
				<div className="fileInfo">
					<a className="filename" href="">{this.props.filename}</a>
				</div>
				<div id={this.props.editorId}></div>
         	</div>
	    )
	}
	
});


var Header = React.createClass({
	
	render: function() {
		return (
			<div className="header">
				<div className="headerContent">
					<ul className="navmenu">
						<li><Link to="/">Listaa gistit</Link></li>
						<li><Link to="creategist">Luo uusi gist</Link></li>
					</ul>
				</div>	
			</div>	
		)
	}

});


var Layout = React.createClass({

	render: function() {
		return (
			<div className="content">
				<Header />
				{this.props.children}
			</div>
		)
	}

});


var CreateGist = React.createClass({

	render: function() {
		return (
			<div>
				<p>Luo uusi gist</p>
			</div>
		)
	}
	

});



var createEditor = function(targetDiv, content) {
	var lines = content.split("\n").length;

	var editor = ace.edit(targetDiv);

	editor.setTheme("ace/theme/cobalt");
	editor.getSession().setMode("ace/mode/java");
	editor.setOption("showPrintMargin", false);
	editor.setOptions({maxLines: lines});
	editor.setValue(content);
	editor.setReadOnly(true);
	editor.selection.moveTo((lines + 1), 0);

}



ReactDOM.render(
	<Router>
		<Route path="/" component={Layout} >
			<IndexRoute component={Gists}></IndexRoute>
			<Route path="creategist" component={CreateGist} />
			<Route path="singlegist" component={} />
		</Route>
	</Router>,
	destination
);

</script>
  
  
</html>